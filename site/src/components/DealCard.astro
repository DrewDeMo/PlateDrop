---
interface Props {
  title: string;
  brand: string;
  price_current: number;
  price_prev?: number;
  discount_pct: number;
  image_url?: string;
  url: string;
  retailer: string;
  rating?: number;
  reviews_count?: number;
}

const {
  title,
  brand,
  price_current,
  price_prev,
  discount_pct,
  image_url,
  url,
  retailer,
  rating,
  reviews_count
} = Astro.props;

const formatPrice = (price: number) => `$${price.toFixed(2)}`;
const savings = price_prev ? price_prev - price_current : 0;

// Product structured data for SEO
const productSchema = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: title,
  brand: {
    '@type': 'Brand',
    name: brand
  },
  image: image_url,
  description: `${title} - ${brand}`,
  offers: {
    '@type': 'Offer',
    url: url,
    priceCurrency: 'USD',
    price: price_current,
    seller: {
      '@type': 'Organization',
      name: retailer
    }
  },
  ...(rating && {
    aggregateRating: {
      '@type': 'AggregateRating',
      ratingValue: rating,
      reviewCount: reviews_count || 0
    }
  })
};
---

<article class="deal-card flex flex-col bg-gradient-card backdrop-blur-glass border border-glass-border rounded-2xl overflow-hidden transition-all duration-[500ms] ease-spring h-full relative animate-fade-in group">
  <div class="card-glow absolute inset-[-2px] bg-gradient-primary rounded-2xl opacity-0 blur-[20px] transition-opacity duration-[400ms] ease-out -z-10"></div>
  
  {image_url && (
    <div class="deal-image relative aspect-[4/3] bg-gradient-to-br from-bg-secondary to-bg-tertiary overflow-hidden">
      <img src={image_url} alt={title} loading="lazy" class="w-full h-full object-cover transition-transform duration-[600ms] ease-spring group-hover:scale-[1.15] group-hover:rotate-[3deg]" />
      <div class="image-overlay absolute inset-0 bg-gradient-to-b from-transparent to-bg/80 opacity-0 transition-opacity duration-[400ms] ease-out group-hover:opacity-100"></div>
      {discount_pct > 0 && (
        <span class="discount-badge absolute top-4 right-4 flex items-center gap-2 bg-gradient-primary text-white px-5 py-3 rounded-full text-sm font-extrabold tracking-wider shadow-glow animate-pulse-slow z-[2]">
          <span class="badge-icon text-[1.2em] animate-float">üî•</span>
          <span class="badge-text uppercase">{Math.round(discount_pct)}% OFF</span>
        </span>
      )}
      <div class="quick-view absolute bottom-4 left-1/2 -translate-x-1/2 translate-y-5 bg-glass-bg backdrop-blur-glass text-text px-6 py-3 rounded-full text-sm font-bold opacity-0 transition-all duration-[450ms] ease-spring border border-glass-border z-[2] group-hover:opacity-100 group-hover:translate-y-0 group-hover:scale-[1.08]">
        <span>Quick View</span>
      </div>
    </div>
  )}
  
  <div class="deal-content flex flex-col gap-4 p-6 flex-1">
    <div class="deal-header flex items-center justify-between gap-3">
      <span class="deal-brand text-sm font-bold bg-gradient-primary bg-clip-text text-transparent uppercase tracking-[0.1em]">{brand}</span>
      <span class="deal-retailer flex items-center gap-1 text-xs text-text-tertiary px-3 py-2 bg-surface-elevated rounded-full border border-border transition-all duration-[400ms] ease-spring group-hover:scale-[1.08] group-hover:border-primary">
        <span class="retailer-icon text-[1.1em] transition-transform duration-[400ms] ease-spring group-hover:rotate-[20deg]">üè™</span>
        {retailer}
      </span>
    </div>
    
    <h3 class="deal-title text-lg font-bold text-text leading-tight m-0 line-clamp-2 min-h-[2.8em]">{title}</h3>
    
    <div class="deal-pricing flex flex-col gap-3 p-4 bg-surface-elevated rounded-lg border border-border">
      <div class="price-wrapper flex items-baseline gap-3">
        <div class="price-current text-3xl font-extrabold bg-gradient-primary bg-clip-text text-transparent leading-none">{formatPrice(price_current)}</div>
        {price_prev && (
          <div class="price-badge flex items-center">
            <span class="price-prev text-base text-text-tertiary line-through opacity-70">{formatPrice(price_prev)}</span>
          </div>
        )}
      </div>
      {savings > 0 && (
        <div class="savings-badge inline-flex items-center gap-2 px-4 py-2 bg-gradient-accent text-bg rounded-full text-sm font-bold self-start shadow-glow-accent transition-all duration-[450ms] ease-spring group-hover:scale-[1.12]">
          <span class="savings-icon text-[1.2em] transition-transform duration-[450ms] ease-spring group-hover:scale-[1.3] group-hover:rotate-[20deg]">üí∞</span>
          <span>Save {formatPrice(savings)}</span>
        </div>
      )}
    </div>
    
    {rating && (
      <div class="deal-rating flex items-center gap-2 py-2">
        <div class="stars flex gap-1 text-accent" aria-label={`${rating} out of 5 stars`}>
          {Array.from({ length: 5 }, (_, i) => (
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill={i < Math.floor(rating) ? 'currentColor' : 'none'}
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="star transition-transform duration-[400ms] ease-spring group-hover:scale-[1.2] group-hover:rotate-[12deg]"
              style={`transition-delay: ${i * 60}ms`}
            >
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
            </svg>
          ))}
        </div>
        {reviews_count && (
          <span class="review-count text-xs text-text-tertiary font-semibold">({reviews_count.toLocaleString()})</span>
        )}
      </div>
    )}
    
    <a href={url} class="deal-link btn btn-primary mt-auto w-full text-base px-6 py-4 relative overflow-hidden" target="_blank" rel="noopener noreferrer">
      <span class="relative z-[1]">{retailer === 'Amazon' ? 'View on Amazon' : 'View Deal'}</span>
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="link-icon relative z-[1] transition-transform duration-[450ms] ease-spring group-hover:translate-x-[6px] group-hover:-translate-y-[6px] group-hover:rotate-[8deg]">
        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
        <polyline points="15 3 21 3 21 9"></polyline>
        <line x1="10" y1="14" x2="21" y2="3"></line>
      </svg>
    </a>

    <p class="affiliate-notice text-xs text-text-tertiary text-center mt-2 italic leading-relaxed m-0">
      {retailer === 'Amazon'
        ? 'As an Amazon Associate, we earn from qualifying purchases.'
        : 'We may earn a commission from this purchase.'}
    </p>
  </div>
</article>

<!-- Product Schema -->
<script type="application/ld+json" set:html={JSON.stringify(productSchema)} />

<style>
  .deal-card:hover {
    @apply -translate-y-4 scale-[1.03] border-primary;
    box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5), 0 0 60px rgba(255, 107, 53, 0.3);
  }
  
  .deal-card:hover .card-glow {
    @apply opacity-60;
  }
  
  .deal-card:active {
    @apply -translate-y-3 scale-[1.01];
    transition: transform 150ms ease-out;
  }
  
  .deal-card:hover .savings-badge {
    box-shadow: 0 0 35px rgba(255, 210, 63, 0.6), 0 10px 40px rgba(0, 0, 0, 0.3);
  }
  
  @media (max-width: 640px) {
    .deal-content {
      @apply p-5 gap-3;
    }
    
    .price-current {
      @apply text-2xl;
    }
    
    .deal-title {
      @apply text-base;
    }
    
    .discount-badge {
      @apply px-4 py-2 text-xs;
    }
  }
</style>
